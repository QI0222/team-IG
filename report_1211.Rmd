---
title: "Political Economy"
author: "Team IG"
subtitle: "Qi Huang, Xinci Chen, Yiru Fei, Shicheng Wang, Kelly Kung"
date: "12/11/2019"
output:
  output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,include=FALSE}
pacman::p_load(readxl,dplyr,tidyverse,ggplot2,plotly,ggpubr,MASS,fitdistrplus,mediation,geepack,conf,car,knitr,gclus,scatterplot3d, ppcor,jtools)
```

```{r,include=FALSE}
# data for part1
olddata<-read_excel("Data for the Final Project.xlsx")
olddata<-as_tibble(olddata)
#select variables that needed for the project and rename some variables
olddata2 <- olddata %>% 
  dplyr::select(State,Highschool,`Union density`,GDP,Urbanity, Population, Export,`Unemployment rate`,`Cost of living`,Gini, White, Black, Hispanic)
names(olddata2)[3]<-"Union_density"
names(olddata2)[8]<-"Unemployment_rate"
names(olddata2)[9]<-"Cost_of_living"
#data transformation: generate a new variable called GV to measure the level of racial diversity
olddata3 <- olddata2 %>% 
  mutate(Racial_diversity=1-White^2-Black^2-Hispanic^2) %>%
  mutate(norm_Racial_diversity = Racial_diversity*(3/2))
```


# 1.Introduction
Our client has been conducting a research about clarifying capital economics on both state and nation scale, while a negative relationship between union density and vocational education has been found during researching process which conflicts to the Variety of Capitalism theory. Initially, this project is to explore whether racial diversity can explain the negative relationship between union density and vocational education. Two types of analysis are involved into this project based on this question. One is capturing this relationship using regression modeling method and another is using mediation analysis to see if racial diversity mediates the relationship.  

# 2.Research Question
According to the Varieties of Capitalism (VoC) theory, the United States is defined as a liberal market economies(LME) and one characteristic of this market type is that the union density is positively related to the vocational education. However, According to the linear model that was conducted and presented by the client, the model contains 9 variables from dataset, highschool stands for the number of people engaging in vocational education and urbanity means the quality of state of being urban. The original model shows below:   

$$Highschool=4.754*10^5-1.692*10^4Uniondensity+6.629*10^(-2)GDP-1.045*10^3Urbanity+$$
$$2.804*10^2Population-51.76Export+1.909*10^4Unemployrate+1.241*10^3Costofliving-9.598*10^5Gini$$   

We see that the coefficient of Union Density is negative which indicates there exists a negative relationship between union density and high school. According to VoC theory, LME(Liberal Market Economies) could have positive relationship between union density and vocation education. The result apparently conflicts with the properties of LME in VoC theory. Accordingly, a potential explanation comes that racial diversity in each state might lead to this negative relationship between vocational education and union density.    
      
# 3.Part I 
## 3.1 Data Interpretation
* Data description  
The client initially sent us data with 31 variables for 51 states in the US including Washington D.C. Not all the variables are used in the regression model. Based on the content of the project, the dependent variable is the number of high school students in vocational training program which represents the vocational training education, and the independent variables include the predictor and other confounding variables. The predictor is the union density, and the confounding variables are proportion of White, Black and Hispanic people, GDP, urbanity, population, export, cost of living, unemployment rate and Gini index. Since the client’s question involves looking at the racial diversity, we computed a measure of racial diversity using the “Generalized Variance” method found in “How to Measure Density When You Must”(David V. Budescu, 2012), using the proportions of White, Black, and Hispanic to the population in each state. This is because the proportions of the races alone do not represent racial diversity.   

* Data governance  
There are several issues with the dataset that may have an implication on the analysis we conduct. First, Data are sourced from different years, from 2016 to 2018. Second, misrepresentation of vocational education. In the original dataset, the vocation education is represented by the number of high school students, which is on the demand side of the vocational education. However, the VoC uses theory to classify countries based on the actions of the government and business. Therefore, it might be more helpful to use the supply side of vocational education rather than the demand side.  Third, misrepresentation of racial diversity. The racial diversity is initially represented by the number of White / Black / Hispanic people. However, the proportion of a single race does not give a measure of racial diversity based on the literature mentioned before. Rather, the normalized racial diversity that is calculated by the proportion of different races is more reasonable. Therefore, a new variable named “normalized racial diversity” is added into the dataset.  

To obtaining the racial diversity, first of all, calculating the proportion of the same race, which is equal to the sum of the proportion of Black squared, proportion of White squared, and proportion of Hispanic squared. Then use one to minus the proportion of same race to get the proportion of different races. However, there are many different ways to collect data on the racial groups, especially which races to collect data on. To alleviate this kind of heterogeneity that can arise when modeling, racial diversity needs to be normalized before adding to the model. We multiply the radical diversity by C/(C-1) can get the normalized racial diversity, where C means the number of race categories. In this case, C is 3.  

$$ Racial Diversity=1-White^2-Black^2-Hispanic^2$$
$$Normal Racial Diversity = Racial Diversity*(3/2)$$

## 3.2 Exploratory Data Analysis

```{r echo=FALSE, warning=FALSE,message=FALSE}
### Initial EDA 
plot1 <-  ggplot(olddata3)+
  geom_point(aes(x=olddata3$Highschool,y=olddata3$Union_density))+
  geom_smooth(aes(x=olddata3$Highschool,y=olddata3$Union_density),se=FALSE)+
  labs(x="Union Density",y="Vocational Education")
plot1
```

This plot visualizes the potential relationship with x-axis set as union density and y-axis set as vocational education. From this plot, there seems to be a negative relationship. But because there are so many leverage points, we can not conclude that this negative relationship actually exists or it is a result of the leverage points.  

```{r,echo = F}
symbols(olddata3$Highschool,olddata3$Union_density,circles= olddata3$norm_Racial_diversity/pi, inches=0.30, fg="white", bg="lightblue",xlab = "Union Density", ylab = "Vocational Education")
```

Moreover, a bubble plot is presented. Similar to the previous plot, we set union density as the independent variable and high school as the dependent variable. However, this time, we replace every data point with a single circle. Each circle represents one state and the radius of the circle represents the racial diversity level, which means, the higher racial diversity level, the larger the circle is. Similar to previous results, by observing this plot we cannot confirm that these two variables have a negative relationship. Furthermore, there does not seem to be a clear pattern in the racial diversity in the states.

## 3.3 Methodology and Result
### 3.3.1 Model I 
* Replicate Original Model  
Since the initial EDA does not suggest a distinctive pattern of the negative relationship between vocational education and unionization, we replicated the model used by the client to confirm the model results.
We are able to replicate her results, the coefficient is the same for the results client provided to us. The negative coefficient at -16915 indicates that for every unit increase in union density, the number of high school students is likely to decrease by 16915. 


* Partial Correlation  
Because there are other factors that will impact the relationship between the outcome variable, vocational education, and union density, partial correlation analysis is implemented to better investigate the relationship between union density and vocational education. Partial correlation is a measure of the strength and direction of a linear relationship between two continuous variables while controlling for the effect of predictors in the regression model. In terms of the strength of relationship, the value of the correlation coefficient varies between +1 and −1. A value of +1 and −1 indicates a perfect degree of association between the two variables. As the correlation coefficient value goes towards 0, the relationship between the two variables will be weaker.

```{r,echo=F}
n = length(olddata3$Highschool)
regress.high = lm(Highschool~GDP+Urbanity+Population+Export+Unemployment_rate+Cost_of_living+Gini, data = olddata3)
regress.Union = lm(Union_density~GDP+Urbanity+Population+Export+Unemployment_rate+Cost_of_living+Gini, data = olddata3)
residuals.high = residuals(regress.high)
residuals.Union = residuals(regress.Union)
plot(residuals.high,residuals.Union,main="Partial Correlation for Original Model",xlab="Residuals for Vocational Training", ylab="Residuals for Union Density")
abline(lm(residuals.Union~residuals.high), col="red")
```  

When conducting partial correlation analysis, a method for computing the partial correlation coefficients has to be specified. Two methods are used in this analysis. One is the Pearson method, which evaluates the linear relationship between two continuous variables. A relationship is linear when a change in one variable is associated with a proportional change in the other variable. The following formula is used to calculate the Pearson correlation:

$$r_{xy} = \frac{n\sum{x_iy_i}-\sum{x_i}\sum{y_i}}{\sqrt{n\sum{x_i}^2-(\sum{x_i})^2}\sqrt{n\sum{y_i}^2-(\sum{y_i})^2}}$$
$r_{xy}$ = Pearson r correlation coefficient between x and y  
$n$ = number of observations  
$x_i$ = value of x (for ith observation)  
$y_i$ = value of y (for ith observation)  

```{r,echo = F}
partial.correlation_s = cor(residuals.high, residuals.Union, method = 'spearman')
test.statistic_s = partial.correlation_s*sqrt((n-2)/(1-partial.correlation_s^2))
p.value_s = 2*pt(abs(test.statistic_s), n-2, lower.tail = F)
```  

Another is the Spearman method, which evaluates the monotonic relationship between two continuous or ordinal variables. In a monotonic relationship, the variables tend to change together, but not necessarily at a constant rate. The Spearman rank correlation test does not carry any assumptions about the distribution of the data and is the appropriate correlation analysis when the variables are measured on a scale that is at least ordinal. The following formula is used to calculate the Spearman rank correlation:

$$\rho = 1 - \frac{6\sum{d_i^2}}{n(n^2-1)}$$  

$\rho$ = Spearman rank correlation  
$d_i$ = the difference between the ranks of corresponding variables  
$n$ = number of observations  

```{r,echo = F}
partial.correlation_p = cor(residuals.high, residuals.Union, method = 'pearson')
test.statistic_p = partial.correlation_p*sqrt((n-2)/(1-partial.correlation_p^2))
p.value_p = 2*pt(abs(test.statistic_p), n-2, lower.tail = F)
```  

Using the pearson method, the partial correlation is −0.4167175 and P-value is 0.002351165, which suggests a moderate negative relationship between union density and vocational education, and we expected vocational education decreases 0.417 unit for one unit increase in union density when all other covariates are held constant.
Using the spearman method, the partial correlation is −0.27575 and P-value is 0.008161668, which also indicates a moderate negative relationship between union density and vocational education, we expected vocational education decreases 0.276 unit for one unit increase in union density when all other covariates are held constant.

From the output of the two methods, correlations between union density and vocational education are negative. The small P-value (<0.05) indicates that the negative coefficient of Union density is statistically significant in the primary model, it means here that it’s not equal to 0, so it suggests that the variables are related. From the partial correlation plot on residual of Union density and residual of Highschool, the red line, which represents the relationship between union density and vocational education, has an apparent downward trend. However, by looking at the points on the graph, there are leverage points in the lower right corner, which indicates that some data transformation might be needed. The next step is to validate the model by checking the assumptions. 

* Assumption Check  

```{r,echo = F}
fittest<-lm(Highschool~Union_density+GDP+Urbanity+Population+Export+Unemployment_rate+Cost_of_living+Gini,data = olddata3)
par(mfrow=c(2,2))
plot(fittest,which=1)
plot(fittest,which=2)
plot(fittest,which=3)
```

The plots above are used to check the assumptions of Linear Regression. These assumptions are linearity assumption, normality assumption, and constant variance assumption. The first plot shown here is Residuals vs Fitted plot which is used to check linearity assumption. An ideal plot should show the equally spread residuals around the horizontal line without any distinct patterns. The plot above indicates the violation of the linearity assumption. The normality assumption can be checked by the Q-Q plot. The ideal plot of residuals should approximately follow a straight line. Some points are skewed at the top right of the plot which indicates the violation of normality assumption. The third plot, which is a scale-location plot can be used to check the assumption of equal variance. An ideal plot will show a horizontal line with randomly spread points. In our case, the constant variance assumption is violated. If the assumptions of Linear Regression are not met, it indicates that a transformation in the linear regression is required.

```{r,echo = F}
crPlots(fittest)
```  

To use the linear regression model, the most significant assumption is that the predictors should be linearly related to the outcome, while accounting for other predictors. Component residual plot is used to plot the relationships between each predictor and the outcome, while accounting for the other predictors. The red line shows a smoothed fit of the data points, and the dashed line indicates the linear best fit. If the red line is close to the dashed line and does not show a curved pattern, it suggests that the linearity assumption is satisfied for that variable. Based on the initial component residual plot of the original model, leverage points exist in data points from different variables including “GDP”, “population”, “Export”, “unemployment rate” and “cost of living”. There are issues with leverage points since it would directly change the pattern of the residual plots. For example, looking at the residual plots of “Export”, if the leverage points move upwards or downwards, the red line and the dashed line would move accordingly. This is not ideal because the red line should indicate the pattern of the majority of the data points, and should not be heavily influenced by just one or two leverage points. To avoid the leverage points, log transformation is used to build the first model, “fit1”.

### 3.3.2 Model II
* Original Model Tranformation  
Because the original model does not align with the assumptions of linear regression, data transformation is used to adjust the model.  

```{r,echo = F}
fit1<-lm(log(Highschool) ~ Union_density+log(GDP)+Urbanity+log(Population)+log(Export)+Unemployment_rate+log(Cost_of_living)+Gini,data = olddata3)
summ(fit1)
```  

In model “fit1”, log transformation has been implemented for the outcome, “highschool” and variables that have leverage points, “GDP”, “population”, “Export”, “unemployment rate” and “cost of living”. After summarizing the model “fit1”, the coefficient between the outcome “highschool” and the variable “union density” is -0.04, and is not significant. The insignificant coefficient indicates that the negative relationship between vocational education and union density is not conclusive.

```{r,echo = F}
crPlots(fit1)
```

After modeling, residual plots are generated to check the validation of the model. Looking at the residual plots in the Appendix, nearly all the residuals are equally distributed around the horizontal line valued at zero, indicating that the residuals are random, and the linearity assumption is satisfied. Looking at the Q-Q plot, a majority of the residual points are aligned with the straight line, indicating the normality assumption is nearly satisfied. Looking at the scale-location plot, most residuals are spread equally along the ranges of predictors, indicating the equal variance assumption is satisfied. Based on the residual plots, the model “fit1” is more valid compared to the original model. Checking the component and residual plots again, the issue regarding the leverage points has been improved a lot. However, two issues still stand. First, there is a leverage point in GDP after taking a log transformation. Second, the variable of union density slightly shows a slight curved pattern, indicating that the linear assumption might not be satisfied, and a more robust model might need to be considered. However, for this analysis, we did not move forward with an analysis using a more robust model.

```{r,echo=F}
olddata4 <-olddata3 %>% 
  filter(GDP<100000)
fit2<-lm(log(Highschool) ~ Union_density+log(GDP)+Urbanity+log(Population)+log(Export)+Unemployment_rate+log(Cost_of_living)+Gini,data = olddata4)
summ(fit2)
```

For a sensitivity analysis, to determine whether the leverage point has a big impact on our regression results, we conduct an analysis by removing the leverage point. The leverage point is Washington DC which has the highest log GDP per capita. Another model (fit2) with exactly the same predictors and outcome is created with a new dataset which excludes the datapoint of Washington DC. After summarizing the model “fit2”, the coefficient of union density changes 20%( from -0.04 in the previous model with DC to -0.066  in this model), indicating that the difference is not ignorable. Thus, the leverage point of Washington DC cannot be simply left out.  

* Partial Correlation  

```{r,echo = F}
n = length(olddata3$Highschool)
regress.high.t = lm(log(Highschool)~log(GDP)+Gini+Urbanity+log(Export)+Unemployment_rate+log(Cost_of_living)+log(Population), data = olddata3)
regress.Union.t = lm(Union_density~log(GDP)+Gini+Urbanity+log(Export)+Unemployment_rate+log(Cost_of_living)+log(Population), data = olddata3)
residuals.high.t = residuals(regress.high.t)
residuals.Union.t = residuals(regress.Union.t)
plot(residuals.high.t,residuals.Union.t,main="Partial Correlation for Transformed Model",xlab="Residuals for Vocational Training", ylab="Residuals for Union Density")
abline(lm(residuals.Union.t~residuals.high.t), col="red")
```

```{r,echo=FALSE}
partial.correlation.t_p = cor(residuals.high.t, residuals.Union.t, method = 'pearson')
test.statistic.t_p = partial.correlation.t_p*sqrt((n-2)/(1-partial.correlation.t_p^2))
p.value.t_p = 2*pt(abs(test.statistic.t_p), n-2, lower.tail = F)
```  

Using the pearson method, the partial correlation is −0.2375583 and P-value is 0.09323562, which suggests we expected vocational education decreases 0.238 unit for one unit increase in union density when all other covariates are held constant.

```{r,echo=FALSE}
partial.correlation.t_s = cor(residuals.high.t, residuals.Union.t, method = 'spearman')
test.statistic.t_s = partial.correlation.t_s*sqrt((n-2)/(1-partial.correlation.t_s^2))
p.value.t_s = 2*pt(abs(test.statistic.t_s), n-2, lower.tail = F)
```

Using the spearman method, the partial correlation is −0.2179186 and P-value is 0.1244902, which is similar to the result of pearson method. We expected vocational education decreases 0.217 unit for one unit increase in union density when all other covariates are held constant. After transformed model, the output of the two methods are pretty close.

Partial correlation analysis is implemented again with transformed variables to check the relationship between union density and vocational education. Looking at the partial correlation plot, the red line becomes flatter.
Based on the output from two methods, the partial correlation coefficients between union density and vocational education are smaller, and p-values are larger. Thus, in the transformed model, the negative relationship between the two union density and vocational training is not as strong as it is in the original model.

### 3.3.3 Model III
* Adding Racial in Transformed Model  
To analyze whether racial diversity can explain the relationship,we add racial diversity as another confounding variable into the next model and check whether there are any differences in the coefficients.  

```{r,echo = F}
fit3<-lm(log(Highschool) ~ Union_density+log(GDP)+Urbanity+log(Population)+log(Export)+Unemployment_rate+log(Cost_of_living)+Gini + norm_Racial_diversity,data = olddata3)
summ(fit3)
```  

The residual plots of adding the normalized racial diversity model are similar to the transformed model; the only change is that adjusted R-squared increases a little bit, from 0.7202 to 0.7503, meaning that this model captures more information from the dataset. R-squared is the proportion of variance explained by the model. High R-squared means the model captures all the variation in the outcome. The adjusted R-squared is a modified version of R-squared and increases only if the new term improves the model more than what we expect by chance. Therefore, after adding normalized racial diversity, the new model fits better than the transformed model, and the coefficient for union density doesn't change that much.  

* Partial Correlation  
By checking the partial correlation of the third model, the red line is pretty close to the horizontal line, indicating that the negative correlation between union density and vocational training is weak. Furthermore, there is a leverage point on the left side of the plot, and this point may affect this slight slope. This red line may become a horizontal line if removing the leverage point.

```{r,echo = F}
regress.high.f = lm(log(Highschool)~log(GDP)+Gini+Urbanity+log(Export)+Unemployment_rate+log(Cost_of_living)+log(Population)+norm_Racial_diversity, data = olddata3)
regress.Union.f = lm(Union_density~log(GDP)+Gini+Urbanity+log(Export)+Unemployment_rate+log(Cost_of_living)+log(Population)+norm_Racial_diversity, data = olddata3)
residuals.high.f = residuals(regress.high.f)
residuals.Union.f = residuals(regress.Union.f)
plot(residuals.high.f,residuals.Union.f,main = "Partial Correlation for Third Model",xlab="Residuals for Vocational Training", ylab="Residuals for Union Density")
abline(lm(residuals.Union.f~residuals.high.f), col="red")
```

```{r,echo = F}
partial.correlation.f_p = cor(residuals.high.f, residuals.Union.f, method = 'pearson')
test.statistic.f_p = partial.correlation.t_p*sqrt((n-2)/(1-partial.correlation.f_p^2))
p.value.f_p = 2*pt(abs(test.statistic.f_p), n-2, lower.tail = F)
```  

Using the pearson method, the partial correlation is −0.1242534 and P-value is 0.3849993. We expected vocational education decreases 0.125 unit for one unit increase in union density when all other covariates are held constant.

```{r,echo = F}
partial.correlation.f_s = cor(residuals.high.f, residuals.Union.f, method = 'spearman')
test.statistic.f_s = partial.correlation.f_s*sqrt((n-2)/(1-partial.correlation.f_s^2))
p.value.f_s = 2*pt(abs(test.statistic.f_s), n-2, lower.tail = F)
```  

Using the spearman method, the partial correlation is −0.1408109 and P-value is 0.09939286. We expected vocational education decreases 0.141 unit for one unit increase in union density when all other covariates are held constant.
Then, from the output of different methods, the partial correlations between union density and vocational education are closer to zero than the transformed model, and P-values (>0.05) are quite large, which indicates this relationship between these two factors is not statistically significant. Therefore, it cannot conclude the correlations are different from zero, which suggests there may not be a relationship between union density and vocational training.

## Conclusion
To summarize the results, two findings are found based on the research question. First, there is no significant relationship between union density and vocational education. Secondly, the racial diversity changes the results of linear model to some extent from -0.04 to -0.02. But for the question of whether the racial diversity explains the relationship, no conclusion can be made. Therefore, in the second pass, mediation analysis is implemented to further explore whether racial diversity mediates the relationship between union density and vocational education.  


# 4.Part II

```{r,include=FALSE}
newdata<-read_csv("new data.csv")
newdata = na.omit(newdata)
newdata = newdata[-c(10,12,14,17,19)]
newdata = newdata%>% 
  mutate(Black = BlackE/Totalpop)
newdata = newdata%>%
mutate(White = WhiteE/Totalpop)
newdata = newdata%>%
mutate(Hispanic = HispanicE/Totalpop)
newdata3 = newdata %>%
  mutate(Racial_diversity = 1-White^2-Black^2-Hispanic^2)
newdata3 = newdata3 %>%
  mutate(norm_Racial_diversity = Racial_diversity *(3/2))
```

## 4.1 Data Interpretation

* Data description  
The second dataset is received from clients to implement the mediation analysis. After the client put more thought into the confounders that need to be taken into account, the data consists of the following:   

Variable Name                    | Interpretation                          | Time Span    
-------------------------------- | --------------------------------------- | ----------------------
Urbanity                         | Quality of being urban in each state    | 2010
Unemployment                     | Unemployment rate in each state         | 2009-2017
GDP_Per_Capital                  | GDP/Population number                   | 2005-2017
Union                            | Union degree for each state             | 2005-2017
Voe                              | Vocational training concentrators       | 2007-2017
Racial(black/hispanic/white)     | Racial proportion for each race         | 2005-2017
Totalpop                         | Total population                        | 2009-2017
Studentpop                       | Student population                      | 2009-2017


* Data governance  
Two main issues are found before starting the analysis. First, the dataset has some missing data. Look into the dataset values for some variables between 2005 and 2009 are missing. Drop this part of data, the model should be built from 2009 to 2017. Besides, the dataset only contains urbanity of 2010, the same value is applied to other years which could influence the analyzing part.   

## 4.2 Methodology and Result
This first part of this section includes a series of models based on data for 2010, the later part includes data from 2009-2017. Both parts concentrate on measuring the relationship between union density and vocation training given the new edition of data. Besides, in order to value how strong racial diversity being a mediator could influence such relationship, mediation analysis has been applied in this part.  

### 4.2.1 Model I:Linear Model on Year 2010

```{r,echo = F}
newdata2 <- filter(newdata3, Year ==2010)
newfit1 = lm(Voe~Union+Urbanity+Unemployment+GDP_Per_Capita+Totalpop,data = newdata2)
summ(newfit1)
```
The first linear model is the regression of vocational education concentrator on union density, Urbanity, Unemployment rate, GDP per Capita and Total Population on the year 2010. Because the urbanity only has data at the year of 2010, we want to do a linear regression on the correct data first before fitting repeated urbanity data. From first model summary, the coefficient of intercept is 208754.90 which means a state level’s vocation education level should be 208754.90 when this state’s union density, urbanity, unemployment, GDP per capita and total population are all valued 0. The coefficient of variable union is -6044.25 which means a unit increase in union density results in an increase in average vocational education level decrease by -6044.25, all other variables held constant.Based on the diagnostic plots from the appendix, the assumptions of linear regression are violated. Log transformation on the outcome and predictors will be used here. 

### 4.2.2 Model II:Model I Transformation
```{r,echo = F}
newfit2 = lm(log(Voe)~Union+Urbanity+Unemployment+log(GDP_Per_Capita)+log(Totalpop),data = newdata2)
summ(newfit2)
```  
Model two is built based on the transformed model. 

This model should be interpreted on the log scale. The coefficient of intercept is 2.65 which means a state level’s vocation education level should be $$\exp(2.65)$$ when this state’s union density, urbanity, unemployment, GDP per capita and total population are all valued 0. The coefficient of variable union is -0.02 which means a unit increase in union density results in a 2% decrease in average vocational education level, all other variables held constant. The coefficient of total pop is 1.01 which means a 1% increase in total population results in a 1.01% increase in average vocational education. The diagnostic plots in the appendix show that the assumptions are met. We do not have enough evidence to reject that there is no relationship between vocational education concentrator and union density based on the P-value(>0.05). 


### 4.2.3 Model III:Model II Add Racial Diversity
```{r,echo = F}
newfit3 = lm(log(Voe)~Union+Urbanity+Unemployment+log(GDP_Per_Capita)+log(Totalpop) + norm_Racial_diversity,data = newdata2)
summ(newfit3)
```  
Model three is built based on the transformed model adding normalized racial diversity. From the summary of this model, the P-value of union density is still large and the coefficient of union density is close to 0. The interpretation should follow same rule as models above. Racial diversity is  unable to explain the negative relationship between union diversity and vocational training.  


### 4.2.4 Mediation Analysis on Model III
To investigate whether racial diversity actually mediates the relationship between union density and vocational education, mediation analysis is conducted. A mediation model proposes that the independent variable influences the mediator variable, which in turn influences the dependent variable. In this project, the union density is the independent variable which serves as the treatment, vocational education is the dependent variable acts as the outcome. Racial diversity is the mediator. This mediation analysis explores whether if union density affects racial diversity first, and racial diversity then affects vocational education. Because mediation analysis is a causal inference model, the assumption of no other unmeasured confounding variables in the model is made.

The direct effect is the effect between treatment (independent variable) and outcome (dependent variable). The mediation effect is the effect between  the treatment and outcome, that goes through the mediator. In the project, the direct effect is the effect of union density and vocational training, through racial diversity. In the mediation analysis, we assume that the sum of the direct effect and the mediation effect is the total effect.
To interpret the results of mediation analysis, the ACME stands for average casual mediation effect, and ADE stands for average direct effect. 

```{r,echo = F}
model.tm1 <- lm(norm_Racial_diversity~Union+Urbanity+Unemployment+log(GDP_Per_Capita)+log(Totalpop),data=newdata2)
model.ty1 <- lm(log(Voe)~Union+norm_Racial_diversity+Urbanity+Unemployment+log(GDP_Per_Capita)+log(Totalpop),data=newdata2)
out.1 <- mediate(model.tm1,model.ty1,sims=1000,treat = "Union",mediator = "norm_Racial_diversity")
summary(out.1)
plot(out.1)
#In this case, we find the racial diversity does not have a mediation effect.
```

Based on the summarized results of mediation analysis using the data on 2010, the direct effect is -0.033, which is not statistically significant, indicating that union density and vocational training does not have strong relationship. Furthermore, the estimate for mediation effect is 0.01, which is very close to 0, indicating that there is nearly no mediation effect. The proportion of mediation effects is -0.16. Looking at the plot, a large portion of the total effect is caused by direct effect, and the mediation effect is around zero, which corresponds to the  prop.mediated result at -0.16 (16%).  

### 4.2.5 Model IV:All Year Model Transformation

```{r,echo=F}
newfit4 = lm(log(Voe) ~ Union+Urbanity+Unemployment+log(GDP_Per_Capita)+log(Totalpop)+factor(Year),data = newdata3)
summ(newfit4)
```

Model four is the model using data from 2009 to 2017. The coefficient of union density is -0.04, which means every 1 unit increases on union density, the Voe expect to decrease 4% $$\exp(-0.04)$$. The coefficients of different year factor is the added on value for coefficients for each variables, setting the year of 2009 as a baseline. For example, the coefficient of union density at the year of 2009 is -0.04, and the coefficient of union density at the year of 2010 is -0.02 (-0.04 + 0.02).

By checking the QQ plot in Appendix, there is one outlier in the lower left, and it is the data for Louisiana in 2010. However, it is unreasonable to remove one year data of one state, so we keep it in the following model.


### 4.2.6 Model V:Model IV Add Racial Diversity

```{r,echo=FALSE}
newfit5 = lm(log(Voe) ~ Union+Urbanity+Unemployment+log(GDP_Per_Capita)+log(Totalpop)+ norm_Racial_diversity+factor(Year),data = newdata3)
summ(newfit5)
```  

After adding the normalized racial diversity to model 4, it is hard to say that racial diversity can explain the negative relationship between union density and Voe.  

### 4.2.7 Mediation Analysis on Model V

```{r,echo =F}
model.tm <- lm(norm_Racial_diversity~Union+Urbanity+Unemployment+log(GDP_Per_Capita)+log(Totalpop)+factor(Year),data=newdata3)
model.ty <- lm(log(Voe)~Union+norm_Racial_diversity+Urbanity+Unemployment+log(GDP_Per_Capita)+log(Totalpop)+factor(Year),data=newdata3)
out.2 <- mediate(model.tm,model.ty,sims=1000,treat = "Union",mediator = "norm_Racial_diversity")
summary(out.2)
plot(out.2)
```

Using the data from 2009 to 2017, the direct effect is -0.0375 but this time it becomes significant, this might indicate that union density and vocational education have negative relationship. But because this finding is based on two assumptions, one is urbanity is the same value as 2010 for all the years, the other is all the confounding variables are included in the model. However, the mediation effect is 0.001, which is around zero. And based on the plot, most of the effect is caused by direct effect and mediation effect ranged around zero, indicating that racial diversity does not mediate the relationship between union density and vocational education.


### 4.2.8 Model VI:Model IV Using Student Population and Racial

```{r,echo=FALSE}
newfit6 = lm(log(Voe) ~ Union+Urbanity+Unemployment+log(GDP_Per_Capita)+log(StudentpopE)+ norm_Racial_diversity+factor(Year),data = newdata3)
summ(newfit6)
```

The dataset contains total population and student population. Because the client wants to know how the student population would influence the results, we with the total population to student population. However, the interpretation of the results would be different. The research question is now targeting to the proportion of students taking vocational education from the total student population rather than the state population. The coefficient of union density is -0.04, which means every 1 unit increases on union density, the VoE expect to decrease 4% $$\exp(-0.04)$$.
 
### 4.2.9 Mediation Analysis on Model VI

```{r,echo =F}
model.sm <- lm(norm_Racial_diversity~Union+Urbanity+Unemployment+log(GDP_Per_Capita)+log(StudentpopE)+factor(Year),data=newdata3)
model.sy <- lm(log(Voe)~Union+norm_Racial_diversity+Urbanity+Unemployment+log(GDP_Per_Capita)+log(StudentpopE)+factor(Year),data=newdata3)
out.3 <- mediate(model.sm,model.sy,sims=1000,treat = "Union",mediator = "norm_Racial_diversity")
summary(out.3)
plot(out.3)
#In this case, we find the racial diversity does not have a mediation effect.
```

For this mediation analysis, student population has replaced the total population. Again, most of the effect is caused by direct effect rather than mediation effect, indicating that racial diversity does not mediate the relationship between union density and vocational education.  

### 4.2.10 Model VII:Model IV Exclude DC

```{r,echo=FALSE}
newdata4 <- filter(newdata3, State!="District of Columbia")
newfit7 = lm(log(Voe) ~ Union+Urbanity+Unemployment+log(GDP_Per_Capita)+log(Totalpop)+factor(Year),data = newdata4)
summ(newfit7)
``` 

The component and residual plot of model four shows that there are some leverage points in GDP per Capita. These leverage points are DC. Thus, the model seven is built on using data which exclude DC. The results indicate that removing leverage points does not change much compared to model four.

### 4.2.11 Model VIII:Model IV Drop the Urbanity 

```{r,echo=FALSE}
newfit8 = lm(log(Voe) ~ Union+Unemployment+log(GDP_Per_Capita)+log(Totalpop)+ norm_Racial_diversity+factor(Year),data = newdata3)
summ(newfit8)
``` 

Our client informed us later that urbanity may not be confouding variable for Vocational Education. Therefore, model eight is regression without urbanity. The results indicate that removing urbanity does not change much compared to model four.

## 4.3 Conclusion   
In conclusion, the coefficients of union density in these models are similar and tend to be significant. According to those coefficients, union density has negative relationship with vocational education. However, these models are built based on two assumptions. First, we assume there are no other unmeasured confounding varibales. Second, we assume urbanity is the same for every year using the data of 2010.
Second, racial diversity has no mediation effect on the negative relationship between union density and vocational education based on the results of mediation analysis.  

# Appendix

## Part1: Results of orignal model
```{r,echo=F}
fittest<-lm(Highschool~Union_density+GDP+Urbanity+Population+Export+Unemployment_rate+Cost_of_living+Gini,data = olddata3)
summ(fittest)
```  

## Part1: Assumption check of transformed model
```{r,echo=F}
par(mfrow=c(2,2))
plot(fit1,which=1)
plot(fit1,which=2)
plot(fit1,which=3)
```

## Part1: Assumption check and crplot when remove dc
```{r,echo=F}
crPlots(fit2)
par(mfrow=c(2,2))
plot(fit2,which=1)
plot(fit2,which=2)
plot(fit2,which=3)
```

## Part1: Assumption check and crplot when add racial diveristy
```{r,echo=F}
par(mfrow=c(2,2))
plot(fit3,which=1)
plot(fit3,which=2)
plot(fit3,which=3)
```

## Part2: Assumption check and crplot when year 2010
```{r,echo=F}
par(mfrow=c(2,2))
plot(newfit1)
crPlots(newfit1)
```


## Part2: Assumption check and crplot when transformed year 2010
```{r,echo=F}
par(mfrow=c(2,2))
plot(newfit2)
crPlots(newfit2)
```


## Part2: Assumption check and crplot when transformed year 2010 and add racial diveristy
```{r,echo=F}
par(mfrow=c(2,2))
plot(newfit3)
crPlots(newfit3)
```


## Part2: Assumption check and crplot when transformed all year
```{r, echo=F}
par(mfrow=c(2,2))
plot(newfit4)
crPlots(newfit4)
``` 

## Part2:  Assumption check and crplot when transformed all year and add racial diveristy
```{r,echo=F}
par(mfrow=c(2,2))
plot(newfit5)
```

## Part2: student pop 
```{r,echo=F}
par(mfrow=c(2,2))
plot(newfit6)
```

## Part2: remove dc
```{r,echo=F}
par(mfrow=c(2,2))
plot(newfit7)
```

## Part2: remove urbanity
```{r,echo=F}
par(mfrow=c(2,2))
plot(newfit8)
```


















