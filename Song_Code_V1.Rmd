---
title: "Song's Project"
author: "Team IG"
date: "11/11/2019"
output: html_document
---

```{r}
pacman::p_load(readxl,dplyr,tidyverse,ggplot2,plotly,ggpubr,MASS,fitdistrplus,mediation,geepack,conf,car)
```

#Loading Data, Data Cleaning
```{r}
data<-read_excel("Data for the Final Project.xlsx")
data<-as_tibble(data)
#select variables that needed for the project and rename some variables
data2 <- data %>% 
  dplyr::select(State,Highschool,`Union density`,GDP,Urbanity, Population, Export,`Unemployment rate`,`Cost of living`,Gini, White, Black, Hispanic)
names(data2)[3]<-"Union_density"
names(data2)[8]<-"Unemployment_rate"
names(data2)[9]<-"Cost_of_living"
#data transformation: generate a new variable called GV to measure the level of racial diversity
data3 <- data2 %>% 
  mutate(Racial_diversity=1-White^2-Black^2-Hispanic^2) %>%
  mutate(norm_Racial_diversity = Racial_diversity*(3/2))
```

#EDA
```{r}
plot1 <-  ggplot(data3)+
  geom_point(aes(x=data3$Highschool,y=data3$Union_density))+
  geom_smooth(aes(x=data3$Highschool,y=data3$Union_density),se=FALSE)+
  labs(x="Union Density",y="Highschool")
plot1
```

#replicate the model
```{r}
fittest<-lm(Highschool~Union_density+GDP+Urbanity+Population+Export+Unemployment_rate+Cost_of_living+Gini,data = data3)
summary(fittest)
#check normality assumption
plot(fittest,which=2)
#check constant variance assumption
plot(fittest,which=3)
#check the component residual plot(also called partial residual plot)
crPlots(fittest)
```

#partial correlation test on original model
```{r}
n = length(data3$Highschool)
regress.high = lm(Highschool ~ GDP+Urbanity+Population+Export+Unemployment_rate+Cost_of_living+Gini, data = data3)
regress.Union = lm(Union_density ~ GDP+Urbanity+Population+Export+Unemployment_rate+Cost_of_living+Gini, data = data3)
residuals.high = residuals(regress.high)
residuals.Union = residuals(regress.Union)
plot(residuals.high,residuals.Union)
abline(lm(residuals.Union~residuals.high), col="red")
qqplot(qnorm(seq(0,1,length=101),mean(residuals.high), sd(residuals.high)),residuals.high)
partial.correlation = cor(residuals.high, residuals.Union, method = 'pearson')
partial.correlation = cor(residuals.high, residuals.Union, method = 'pearson')
partial.correlation
test.statistic = partial.correlation*sqrt((n-3)/(1-partial.correlation^2))
p.value = 2*pt(abs(test.statistic), n-3, lower.tail = F)
p.value
a= lm(residuals.Union~residuals.high)
plot(a,which=2)
```

#Improve the model by transformation
```{r}
fit1<-lm(log(Highschool) ~ Union_density+log(GDP)+Urbanity+log(Population)+log(Export)+Unemployment_rate+log(Cost_of_living)+Gini,data = data3)
summary(fit1)
crPlots(fit1)
plot(fit1,which=2)
plot(fit1,which=3)
```

#Partial correlation test on transformation model
```{r}
regress.high.t = lm(log(Highschool)~log(GDP)+Urbanity+log(Population)+log(Export)+Unemployment_rate+Cost_of_living+Gini, data = data3)
regress.Union.t = lm(Union_density~log(GDP)+Urbanity+log(Population)+log(Export)+Unemployment_rate+Cost_of_living+Gini, data = data3)
residuals.high.t = residuals(regress.high.t)
residuals.Union.t = residuals(regress.Union.t)
plot(residuals.high.t,residuals.Union.t)
abline(lm(residuals.Union.t~residuals.high.t), col="red")
qqplot(qnorm(seq(0,1,length=101),mean(residuals.high.t), sd(residuals.high.t)),residuals.high.t)
partial.correlation.t = cor(residuals.high.t, residuals.Union.t, method = 'pearson')
partial.correlation.t = cor(residuals.high.t, residuals.Union.t, method = 'pearson')
test.statistic.t = partial.correlation.t*sqrt((n-3)/(1-partial.correlation.t^2))
partial.correlation.t
p.value.t = 2*pt(abs(test.statistic.t), n-3, lower.tail = F)
p.value.t
b = lm(residuals.Union.t~residuals.high.t)
plot(b,which=2)
```

#Trying to remove the highest value in GDP and refit
```{r}
data4 <-data3 %>% 
  filter(GDP<100000)
fit2<-lm(log(Highschool) ~ Union_density+log(GDP)+Urbanity+log(Population)+log(Export)+Unemployment_rate+Cost_of_living+Gini,data = data4)
summary(fit2)
crPlots(fit2)
plot(fit2,which=2)
plot(fit2,which=3)
```

#Racial Diversity
```{r}
fit3<-lm(log(Highschool) ~ Union_density+log(GDP)+Urbanity+log(Population)+log(Export)+Unemployment_rate+Cost_of_living+Gini+norm_Racial_diversity,data = data3)
summary(fit3)
```

#others,needs more discussion
```{r,eval=FALSE}
#It looks like there is a weak negative relationship, but how much confident can we deliver that message?
randomtest <- rnorm(length(cleandata$Highschool),mean =mean(cleandata$`Union density`), sd = sd(cleandata$`Union density`))
xtest <- cleandata$Highschool
summary(lm(randomtest~xtest))
ggplot()+aes(x = xtest,y = randomtest)+geom_point()+geom_smooth(method = "lm")
```

#Shicheng'sï¼Œneeds more discussion
```{r, eval=FALSE}
## package
library(knitr)
library(tidyverse)
library(kableExtra)
library(shiny)
library(car)
library(gclus)
library(scatterplot3d)
attach(new)
library(readxl)
library(dplyr)
library(corrplot)
library(ggplot2)
library(ppcor)



## data process
new<-select(data,1,3,5:11,22,23,27:29)
new$State<-as.numeric(new$State)
new$GDP<-as.numeric(new$GDP)
new$Gini<-as.numeric(new$Gini)
new$Urbanity<-as.numeric(new$Urbanity)
new$Population<-as.numeric(new$Population)
new$Export<-as.numeric(new$Export)
new$Unemployment.rate<-as.numeric(new$Unemployment.rate)
new$Highschool<-as.numeric(new$Highschool)
new$Union.density<-as.numeric(new$Union.density)

new$ratio<-as.numeric(new$Highschool)/as.numeric(new$Population)

## rough relationship without control
da <- read.csv("Data for the Final Project.csv")
data <- da[1:51,1:31]


ggplot(data,aes(x=White, y = Union.density)) + 
  geom_point(color='#3399CC',size=4)+
  geom_smooth(method = lm,color='#3366FF')

ggplot(data,aes(x=Black, y = Union.density)) + 
  geom_point(color='#CC6666',size=4)+
  geom_smooth(method = lm,color='#663300')

ggplot(data,aes(x=Hispanic, y = Union.density)) + 
  geom_point(color='#00CC66',size=4)+
  geom_smooth(method = lm,color='#006666')

## other plots that see the relationships
symbols(Union.density,Highschool,circles = new$White/pi,inches=0.30, fg="white", bg="lightblue") 


car::spm(~Union.density+Highschool, data = new,  
         smooth=list(lty.smooth=2,lwd.smooth = 3, col.smooth="red", spread = T, lty.spread=3, lwd.spread=2),  
         diagonal = list(method="density"), regLine=list(method =lm,lty=1,lwd=2,col="blue"), 
         cex = 1, cex.labels = 1.5, cex.axis = 1.5, 
         pch = c(16,16,16), col = c("red", "green3", "blue"), row1attop = T ) 

s3d<-scatterplot3d(Union.density,White,Highschool, pch=16, highlight.3d=TRUE,type="h") 
f <- lm(Highschool~Union.density+White) 
s3d$plane3d(f,lty.box = "solid")

## corelation test
cor(news,method = "spearman")


## cr-plot
colnames(data)[2] <- "uniondensity"
fit1 <- lm(Highschool ~ uniondensity+ GDP+Urbanity+Population+Export+`Cost of living`+`Unemployment rate`+Gini,data)

fit2 <- lm(Highschool ~ uniondensity+ GDP+Urbanity+log(Population)+Export+`Cost of living`+`Unemployment rate`+Gini,data)

fit3 <- lm(Highschool ~ uniondensity+ GDP+Urbanity+log(scale(Population^1/2))+scale(Export^1/2)+`Cost of living`+`Unemployment rate`+Gini,data)

crPlots(fit1)
crPlots(fit2)
crPlots(fit3)
```

#mediation analysis
```{r,eval=FALSE}
##mediation analysis
pacman::p_load(mediation,quantreg)
data("jobs")
model.m<-lm(job_seek~treat+depress1+econ_hard+sex+age+occp+marital+nonwhite+educ+income,data=jobs)
model.y<-lm(depress2~treat+job_seek+depress1+econ_hard+sex+age+occp+marital+nonwhite+educ+income,data=jobs)
out.1<-mediate(model.m,model.y,sims=1000,boot=TRUE,treat = "treat",mediator="job_seek")
out.2<-mediate(model.m,model.y,sims=1000,treat = "treat",mediator="job_seek")
summary(out.2)
#In this case, we find that job search self-efficacy mediated the effect of the treatment on depression in the negative direction.
#This effect, however, was small with a point estimate of -0.014 and the 95% confidence interval barely covers 0.
plot(out.2)
model.y<-lm(depress2~treat+job_seek+treat:job_seek+depress1+econ_hard+sex+age+occp+marital+nonwhite+educ+income,data=jobs)
out.3<-mediate(model.m,model.y,sims=1000,treat="treat",mediator = "job_seek")
summary(out.3) #how to illustrate the result?
plot(out.3,treatment="both")
model.m<-lm(job_seek~treat+depress1+econ_hard+sex+age+occp+marital+nonwhite+educ+income,data=jobs)
model.y<-rq(depress2~treat+job_seek+depress1+econ_hard+sex+age+occp+marital+nonwhite+educ+income,data=jobs)
out.6<-mediate(model.m,model.y,sims=1000,boot=TRUE,treat="treat",mediator="job_seek")
summary(out.6)

#Discrete Mediator and Outcome Data
model.m<-lm(job_seek~treat+depress1+econ_hard+sex+age+occp+marital+nonwhite+educ+income,data=jobs)
model.y<-glm(work1~treat+job_seek+depress1+econ_hard+sex+age+occp+marital+nonwhite+educ+income,
             family=binomial(link="probit"),data=jobs)
out.7<-mediate(model.m,model.y,sims=1000,treat="treat",mediator="job_seek")
summary(out.7)

#Sensitivity analysis
sens.cont<-medsens(out.7,rho.by=0.05)
summary(sens.cont)
#R^2_M*R^2_Y is the product of coeeficients of determination which represents the proportion of the previously unexplained variance in the
#mediator and and outcome variabls that is explained by an unobservable pretreatment unconfounder.
plot(sens.cont,sens.par="rho")
#the dashed horizontal line represents the estimated mediation effect under the sequential ignorability assumption,
#and the solid line represents the mediation effect under various values of p. 
#The grey region represents the 95% confidence bands.
plot(sens.cont,sens.par = "R2",r.type="total",sign.prod = "negative")
```

