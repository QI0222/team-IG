---
title: "Song's Project"
author: "Team IG"
date: "11/11/2019"
output: html_document
---

```{r}
pacman::p_load(readxl,dplyr,tidyverse,ggplot2,plotly,ggpubr,MASS,fitdistrplus,mediation,geepack,conf,car,knitr,gclus,scatterplot3d, ppcor)
```

#Loading Data, Data Cleaning
```{r}
data<-read_excel("Data for the Final Project.xlsx")
data<-as_tibble(data)
#select variables that needed for the project and rename some variables
data2 <- data %>% 
  dplyr::select(State,Highschool,`Union density`,GDP,Urbanity, Population, Export,`Unemployment rate`,`Cost of living`,Gini, White, Black, Hispanic)
names(data2)[3]<-"Union_density"
names(data2)[8]<-"Unemployment_rate"
names(data2)[9]<-"Cost_of_living"
#data transformation: generate a new variable called GV to measure the level of racial diversity
data3 <- data2 %>% 
  mutate(Racial_diversity=1-White^2-Black^2-Hispanic^2) %>%
  mutate(norm_Racial_diversity = Racial_diversity*(3/2))
```

#EDA
```{r}
plot1 <-  ggplot(data3)+
  geom_point(aes(x=data3$Highschool,y=data3$Union_density))+
  geom_smooth(aes(x=data3$Highschool,y=data3$Union_density),se=FALSE)+
  labs(x="Union Density",y="Highschool")
plot1
```

#replicate the model
```{r}
fittest<-lm(Highschool~Union_density+GDP+Urbanity+Population+Export+Unemployment_rate+Cost_of_living+Gini,data = data3)
summary(fittest)
#check normality assumption
plot(fittest,which=2)
#check constant variance assumption
plot(fittest,which=3)
#check the component residual plot(also called partial residual plot)
crPlots(fittest)
```

#partial correlation test on original model
```{r}
n = length(data3$Highschool)
regress.high = lm(Highschool ~ GDP+Urbanity+Population+Export+Unemployment_rate+Cost_of_living+Gini, data = data3)
regress.Union = lm(Union_density ~ GDP+Urbanity+Population+Export+Unemployment_rate+Cost_of_living+Gini, data = data3)
residuals.high = residuals(regress.high)
residuals.Union = residuals(regress.Union)
plot(residuals.high,residuals.Union)
abline(lm(residuals.Union~residuals.high), col="red")

partial.correlation_s = cor(residuals.high, residuals.Union, method = 'spearman')
partial.correlation_s
test.statistic_s = partial.correlation_s*sqrt((n-3)/(1-partial.correlation_s^2))
p.value_s = 2*pt(abs(test.statistic_s), n-3, lower.tail = F)
p.value_s

partial.correlation_p = cor(residuals.high, residuals.Union, method = 'pearson')
partial.correlation_p
test.statistic_p = partial.correlation_p*sqrt((n-3)/(1-partial.correlation_p^2))
p.value_p = 2*pt(abs(test.statistic_p), n-3, lower.tail = F)
p.value_p
```

#Improve the model by transformation
```{r}
fit1<-lm(log(Highschool) ~ Union_density+log(GDP)+Urbanity+log(Population)+log(Export)+Unemployment_rate+log(Cost_of_living)+Gini,data = data3)
summary(fit1)
crPlots(fit1)
plot(fit1,which=2)
plot(fit1,which=3)
```

#Partial correlation test on transformation model
```{r}
regress.high.t = lm(log(Highschool)~log(GDP)+Urbanity+log(Population)+log(Export)+Unemployment_rate+log(Cost_of_living)+Gini, data = data3)
regress.Union.t = lm(Union_density~log(GDP)+Urbanity+log(Population)+log(Export)+Unemployment_rate+log(Cost_of_living)+Gini, data = data3)
residuals.high.t = residuals(regress.high.t)
residuals.Union.t = residuals(regress.Union.t)
plot(residuals.high.t,residuals.Union.t)
abline(lm(residuals.Union.t~residuals.high.t), col="red")

partial.correlation.t_s = cor(residuals.high.t, residuals.Union.t, method = 'spearman')
partial.correlation.t_s
test.statistic.t_s = partial.correlation.t_s*sqrt((n-3)/(1-partial.correlation.t_s^2))
p.value.t_s = 2*pt(abs(test.statistic.t_s), n-3, lower.tail = F)
p.value.t_s

partial.correlation.t_p = cor(residuals.high.t, residuals.Union.t, method = 'pearson')
partial.correlation.t_p
test.statistic.t_p = partial.correlation.t_p*sqrt((n-3)/(1-partial.correlation.t_p^2))
p.value.t_p = 2*pt(abs(test.statistic.t_p), n-3, lower.tail = F)
p.value.t_p
```

#Trying to remove the highest value in GDP and refit
```{r}
data4 <-data3 %>% 
  filter(GDP<100000)
fit2<-lm(log(Highschool) ~ Union_density+log(GDP)+Urbanity+log(Population)+log(Export)+Unemployment_rate+Cost_of_living+Gini,data = data4)
summary(fit2)
crPlots(fit2)
plot(fit2,which=2)
plot(fit2,which=3)
```

#Racial Diversity
```{r}
fit3<-lm(log(Highschool) ~ Union_density+log(GDP)+Urbanity+log(Population)+log(Export)+Unemployment_rate+log(Cost_of_living)+Gini+norm_Racial_diversity,data = data3)
summary(fit3)
```

#Partial correlation test on Racial Diversity model
```{r}
regress.high.f = lm(log(Highschool)~log(GDP)+Gini+Urbanity+log(Export)+Unemployment_rate+log(Cost_of_living)+log(Population)+norm_Racial_diversity, data = data)
regress.Union.f = lm(`Union density`~log(GDP)+Gini+Urbanity+log(Export)+Unemployment_rate+log(Cost_of_living)+log(Population)+norm_Racial_diversity, data = data)
residuals.high.f = residuals(regress.high.f)
residuals.Union.f = residuals(regress.Union.f)
plot(residuals.high.f,residuals.Union.f)
abline(lm(residuals.Union.f~residuals.high.f), col="red")
partial.correlation.f_s = cor(residuals.high.f, residuals.Union.f, method = 'spearman')
test.statistic.f_s = partial.correlation.f_s*sqrt((n-3)/(1-partial.correlation.f_s^2))
p.value.f_s = 2*pt(abs(test.statistic.f_s), n-3, lower.tail = F)

partial.correlation.f_p = cor(residuals.high.f, residuals.Union.f, method = 'pearson')
test.statistic.f_p = partial.correlation.t_p*sqrt((n-3)/(1-partial.correlation.f_p^2))
p.value.f_p = 2*pt(abs(test.statistic.f_p), n-3, lower.tail = F)
```


```{r}

###
da <- read.csv("Data for the Final Project.csv")
data <- da[1:51,1:31]
new<-dplyr::select(data,1,3,5:11,22,23,27:29)
###
new$GDP<-as.numeric(new$GDP)
new$Gini<-as.numeric(new$Gini)
new$Urbanity<-as.numeric(new$Urbanity)
new$Population<-as.numeric(new$Population)
new$Export<-as.numeric(new$Export)
new$Unemployment.rate<-as.numeric(new$Unemployment.rate)
new$Highschool<-as.numeric(new$Highschool)
new$Union.density<-as.numeric(new$Union.density)
new$ratio<-as.numeric(new$Highschool)/as.numeric(new$Population)
###
symbols(new$Union.density,new$Highschool,circles = new$White/pi,inches=0.30, fg="white", bg="lightblue") 
###
car::spm(~Union.density+Highschool, data = new,  
         smooth=list(lty.smooth=2,lwd.smooth = 3, col.smooth="red", spread = T, lty.spread=3, lwd.spread=2),  
         diagonal = list(method="density"), regLine=list(method =lm,lty=1,lwd=2,col="blue"), 
         cex = 1, cex.labels = 1.5, cex.axis = 1.5, 
         pch = c(16,16,16), col = c("red", "green3", "blue"), row1attop = T ) 
###
s3d<-scatterplot3d(new$Union.density,new$White,new$Highschool, pch=16, highlight.3d=TRUE,type="h") 
f <- lm(Highschool~Union.density+White) 
s3d$plane3d(f,lty.box = "solid")
```


#others,needs more discussion
```{r,eval=FALSE}
#It looks like there is a weak negative relationship, but how much confident can we deliver that message?
randomtest <- rnorm(length(cleandata$Highschool),mean =mean(cleandata$`Union density`), sd = sd(cleandata$`Union density`))
xtest <- cleandata$Highschool
summary(lm(randomtest~xtest))
ggplot()+aes(x = xtest,y = randomtest)+geom_point()+geom_smooth(method = "lm")
```







#mediation analysis
```{r,eval=FALSE}
##mediation analysis
pacman::p_load(mediation,quantreg)
data("jobs")
model.m<-lm(job_seek~treat+depress1+econ_hard+sex+age+occp+marital+nonwhite+educ+income,data=jobs)
model.y<-lm(depress2~treat+job_seek+depress1+econ_hard+sex+age+occp+marital+nonwhite+educ+income,data=jobs)
out.1<-mediate(model.m,model.y,sims=1000,boot=TRUE,treat = "treat",mediator="job_seek")
out.2<-mediate(model.m,model.y,sims=1000,treat = "treat",mediator="job_seek")
summary(out.2)
#In this case, we find that job search self-efficacy mediated the effect of the treatment on depression in the negative direction.
#This effect, however, was small with a point estimate of -0.014 and the 95% confidence interval barely covers 0.
plot(out.2)
model.y<-lm(depress2~treat+job_seek+treat:job_seek+depress1+econ_hard+sex+age+occp+marital+nonwhite+educ+income,data=jobs)
out.3<-mediate(model.m,model.y,sims=1000,treat="treat",mediator = "job_seek")
summary(out.3) #how to illustrate the result?
plot(out.3,treatment="both")
model.m<-lm(job_seek~treat+depress1+econ_hard+sex+age+occp+marital+nonwhite+educ+income,data=jobs)
model.y<-rq(depress2~treat+job_seek+depress1+econ_hard+sex+age+occp+marital+nonwhite+educ+income,data=jobs)
out.6<-mediate(model.m,model.y,sims=1000,boot=TRUE,treat="treat",mediator="job_seek")
summary(out.6)

#Discrete Mediator and Outcome Data
model.m<-lm(job_seek~treat+depress1+econ_hard+sex+age+occp+marital+nonwhite+educ+income,data=jobs)
model.y<-glm(work1~treat+job_seek+depress1+econ_hard+sex+age+occp+marital+nonwhite+educ+income,
             family=binomial(link="probit"),data=jobs)
out.7<-mediate(model.m,model.y,sims=1000,treat="treat",mediator="job_seek")
summary(out.7)

#Sensitivity analysis
sens.cont<-medsens(out.7,rho.by=0.05)
summary(sens.cont)
#R^2_M*R^2_Y is the product of coeeficients of determination which represents the proportion of the previously unexplained variance in the
#mediator and and outcome variabls that is explained by an unobservable pretreatment unconfounder.
plot(sens.cont,sens.par="rho")
#the dashed horizontal line represents the estimated mediation effect under the sequential ignorability assumption,
#and the solid line represents the mediation effect under various values of p. 
#The grey region represents the 95% confidence bands.
plot(sens.cont,sens.par = "R2",r.type="total",sign.prod = "negative")
```

